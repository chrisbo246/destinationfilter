{"version":3,"sources":["../../app/scripts/mapEvents.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;AAmBA,IAAI,eAAe,GAAG,CAAC,UAAU,SAAS,EAAE;AACxC,gBAAY,CAAC;;AAEb,WAAO,CAAC,IAAI,CAAC,wBAAwB,CAAC,CAAC;;AAEvC,QAAI,UAAU,CAAC;;;;;;AAOf,QAAI,QAAQ,GAAG,SAAX,QAAQ,CAAa,KAAK,EAAE;AAC5B,YAAI,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,KAAK,GAAG,GAAG,CAAA,GAAI,GAAG,CAAC,CAAC;AAC7C,eAAO,KAAK,GAAI,MAAM,GAAG,GAAG,AAAC,CAAC;KACjC,CAAA;;;;;;AAQD,QAAI,UAAU,GAAG,SAAb,UAAU,CAAa,GAAG,EAAE;AAC5B,YAAI,GAAG,GAAG,GAAG,CAAC,GAAG;YACb,MAAM,GAAG,SAAS,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC,eAAe,CAAC,SAAS,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC;YACzE,UAAU,GAAG,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,MAAM,CAAC,aAAa,CAAC,MAAM,CAAC,EAAE,WAAW,EAAE,WAAW,CAAC;YACzF,QAAQ,GAAG,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,MAAM,CAAC,WAAW,CAAC,MAAM,CAAC,EAAE,WAAW,EAAE,WAAW,CAAC,CAAC;AAC1F,gBAAQ,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,KAAK,GAAG,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;AAC3E,gBAAQ,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC,KAAK,GAAG,UAAU,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAA;AAClE,gBAAQ,CAAC,cAAc,CAAC,OAAO,CAAC,CAAC,KAAK,GAAG,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;AAC1E,gBAAQ,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC,KAAK,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;KACjE,CAAA;;;;;;AAQD,QAAI,sBAAsB,GAAG,SAAzB,sBAAsB,CAAa,KAAK,EAAE;;AAE1C,kBAAU,CAAC,GAAG,CAAC;AACX,gBAAI,EAAE,KAAK,CAAC,CAAC,CAAC,GAAG,IAAI;AACrB,eAAG,EAAE,AAAC,KAAK,CAAC,CAAC,CAAC,GAAG,EAAE,GAAI,IAAI;SAC9B,CAAC,CAAC;AACH,YAAI,OAAO,GAAG,SAAS,CAAC,GAAG,CAAC,qBAAqB,CAAC,KAAK,EAAE,UAAU,OAAO,EAAE;;AACxE,mBAAO,OAAO,CAAC;SAClB,CAAC,CAAC;AACH,YAAI,OAAO,EAAE;AACT,sBAAU,CAAC,OAAO,CAAC,MAAM,CAAC,CACrB,IAAI,CAAC,qBAAqB,EAAE,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAChD,OAAO,CAAC,UAAU,CAAC,CACnB,OAAO,CAAC,MAAM,CAAC,CAAC;SACxB,MAAM;AACH,sBAAU,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;SAC9B;KAEJ,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAmCF,QAAI,sBAAsB,GAAG,SAAzB,sBAAsB,CAAa,KAAK,EAAE;;;AAE1C,YAAI,OAAO,CAAC;;AAEZ,eAAO,GAAG,SAAS,CAAC,GAAG,CAAC,qBAAqB,CAAC,KAAK,EAAE,UAAU,OAAO,EAAE;;AACpE,mBAAO,OAAO,CAAC;SAClB,CAAC,CAAC;;AAEH,YAAI,OAAO,EAAE;AACT,gBAAI,GAAG,GAAG,OAAO,CAAC,KAAK,EAAE,CAAC;AAC1B,mBAAO,CAAC,GAAG,CAAC,eAAe,GAAG,GAAG,GAAG,IAAI,GAAG,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,GAAG,GAAG,CAAC,CAAC;;AAEtE,gCAAoB,CAAC,kBAAkB,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;AACrD,aAAC,CAAC,kBAAkB,CAAC,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;SACvC;KAEJ,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyFF,KAAC,CAAC,YAAY;;;;AAKV,YAAI,UAAU,GAAG,QAAQ,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC;AAChD,YAAI,YAAY,GAAG,QAAQ,CAAC,cAAc,CAAC,OAAO,CAAC,CAAC;;;;;;AAMpD,kBAAU,GAAG,CAAC,CAAC,cAAc,CAAC,CAAC;;AAE/B,kBAAU,CAAC,OAAO,CAAC;AACf,qBAAS,EAAE,KAAK;AAChB,mBAAO,EAAE,QAAQ;SACpB,CAAC,CAAC;;AAIH,SAAC,CAAC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,EAAE,SAAS,CAAC,aAAa,CAAC,CAAC,IAAI,CAAC,YAAY;;;;;;AAM3E,qBAAS,CAAC,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,UAAU,GAAG,EAAE;;;AAGrC,sCAAsB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;;AAElC,sCAAsB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;aACrC,CAAC,CAAC;;;;;;AAQH,qBAAS,CAAC,GAAG,CAAC,EAAE,CAAC,aAAa,EAAE,UAAU,GAAG,EAAE;;AAE3C,oBAAI,KAAK,EACL,UAAU,EACV,GAAG,CAAC;;AAER,oBAAI,GAAG,CAAC,QAAQ,EAAE;AACd,8BAAU,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;AAC3B,2BAAO;iBACV;AACD,qBAAK,GAAG,SAAS,CAAC,GAAG,CAAC,aAAa,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;AACvD,0BAAU,GAAG,SAAS,CAAC,GAAG,CAAC,kBAAkB,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;AACjE,mBAAG,GAAG,SAAS,CAAC,GAAG,CAAC,iBAAiB,CAAC,KAAK,CAAC,CAAC;;;;;;;AAO7C,oBAAI,GAAG,CAAC,QAAQ,EAAE;AACd,qBAAC,CAAC,YAAY,CAAC,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;AACnC,2BAAO;iBACV;AACD,yBAAS,CAAC,GAAG,CAAC,SAAS,EAAE,CAAC,KAAK,CAAC,MAAM,GAAG,GAAG,GAAG,SAAS,GAAG,EAAE,CAAC;aAEjE,CAAC,CAAC;;;;AAMH,qBAAS,CAAC,GAAG,CAAC,EAAE,CAAC,SAAS,EAAE,UAAU,CAAC,CAAC;;AAGxC,gBAAI,aAAa,GAAG,SAAS,CAAC,GAAG,CAAC,WAAW,EAAE,CAAC;;;AAGhD,aAAC,CAAC,aAAa,CAAC,CAAC,MAAM,CAAC,YAAY;AAChC,yBAAS,CAAC,GAAG,CAAC,UAAU,EAAE,CAAC;AAC3B,uBAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC;aACnC,CAAC,CAAC;;;;;;;AAWH,aAAC,CAAC,aAAa,CAAC,CAAC,EAAE,CAAC,WAAW,EAAE,UAAU,GAAG,EAAE;AAC5C,oBAAI,KAAK,GAAG,SAAS,CAAC,GAAG,CAAC,aAAa,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;AAC3D,sCAAsB,CAAC,KAAK,CAAC,CAAC;aACjC,CAAC,CAAC;;AAEH,mBAAO,CAAC,OAAO,CAAC,wBAAwB,CAAC,CAAC;SAE7C,CAAC,CAAC;KAEN,CAAC,CAAC;;;CAMN,CAAA,CAAE,SAAS,IAAI,EAAE,CAAC,CAAC","file":"mapEvents.js","sourcesContent":["/*old-jslint indent: 2, unparam: true, plusplus: true */\r\n/*\r\njslint\r\n    devel: true,\r\n    browser: true,\r\n    node: false\r\n*/\r\n/*\r\nglobal\r\n    ol,\r\n    showCountryDetails,\r\n    deferred: true,\r\n    map: true,\r\n    popupElement: true,\r\n    infoOverlay: true\r\n*/\r\n\r\n\r\n\r\nvar mapEventsModule = (function (mapModule) {\r\n    'use strict';\r\n    \r\n    console.time('Map events initialized');\r\n    \r\n    var mapTooltip;\r\n    \r\n    \r\n    /**\r\n     * See http://openlayers.org/en/v3.4.0/examples/moveend.html\r\n     */\r\n\r\n    var _wrapLon = function (value) {\r\n        var worlds = Math.floor((value + 180) / 360);\r\n        return value - (worlds * 360);\r\n    }\r\n\r\n\r\n\r\n    /**\r\n     * See http://openlayers.org/en/v3.4.0/examples/moveend.html\r\n     */\r\n\r\n    var _onMoveEnd = function (evt) {\r\n        var map = evt.map,\r\n            extent = mapModule.map.getView().calculateExtent(mapModule.map.getSize()),\r\n            bottomLeft = ol.proj.transform(ol.extent.getBottomLeft(extent), 'EPSG:3857', 'EPSG:4326'),\r\n            topRight = ol.proj.transform(ol.extent.getTopRight(extent), 'EPSG:3857', 'EPSG:4326');\r\n        document.getElementById('left').value = _wrapLon(bottomLeft[0]).toFixed(2);\r\n        document.getElementById('bottom').value = bottomLeft[1].toFixed(2)\r\n        document.getElementById('right').value = _wrapLon(topRight[0]).toFixed(2);\r\n        document.getElementById('top').value = topRight[1].toFixed(2);\r\n    }\r\n\r\n\r\n\r\n    /**\r\n     * See http://openlayers.org/en/v3.4.0/examples/kml-timezones.html\r\n     */\r\n\r\n    var _displayFeatureTooltip = function (pixel) {\r\n        //console.info('#map-tooltip 2:'+JSON.stringify(mapTooltip));\r\n        mapTooltip.css({\r\n            left: pixel[0] + 'px',\r\n            top: (pixel[1] - 15) + 'px'\r\n        });\r\n        var feature = mapModule.map.forEachFeatureAtPixel(pixel, function (feature) { // feature, layer\r\n            return feature;\r\n        });\r\n        if (feature) {\r\n            mapTooltip.tooltip('hide')\r\n                .attr('data-original-title', feature.get('name'))\r\n                .tooltip('fixTitle')\r\n                .tooltip('show');\r\n        } else {\r\n            mapTooltip.tooltip('hide');\r\n        }\r\n\r\n    };\r\n\r\n\r\n\r\n    /**\r\n     * Display country name and flag\r\n     * See http://openlayers.org/en/v3.4.0/examples/tileutfgrid.html\r\n     */\r\n    /*\r\n    var _displayGridSourceInfoOverlay = function (coordinate) {\r\n\r\n        var view = mapModule.map.getView();\r\n        var viewResolution = / ** @type {number} * / (view.getResolution());\r\n        gridSource.forDataAtCoordinateAndResolution(coordinate, viewResolution,\r\n            function (data) {\r\n                // If you want to use the template from the TileJSON,\r\n                //  load the mustache.js library separately and call\r\n                //  info.innerHTML = Mustache.render(gridSource.getTemplate(), data);\r\n                mapElement.style.cursor = data ? 'pointer' : '';\r\n                if (data) {\r\n                    flagElement.src = 'data:image/png;base64,' + data.flag_png;\r\n                    nameElement.innerHTML = data.admin;\r\n                }\r\n                mapOverlaysModule.infoOverlay.setPosition(data ? coordinate : undefined);\r\n\r\n            });\r\n    };\r\n    */\r\n\r\n\r\n\r\n    /**\r\n     * Open country details modal\r\n     */\r\n\r\n    var _displayCountryDetails = function (pixel) { // coordinate\r\n\r\n        var feature;\r\n\r\n        feature = mapModule.map.forEachFeatureAtPixel(pixel, function (feature) { // feature, layer\r\n            return feature;\r\n        });\r\n\r\n        if (feature) {\r\n            var cid = feature.getId();\r\n            console.log('Show feature ' + cid + ' \"' + feature.get('name') + '\"');\r\n            \r\n            countryDetailsModule.showCountryDetails(cid, 'ISO3');\r\n            $('#country_details').modal('show');\r\n        }\r\n\r\n    };\r\n\r\n\r\n    /**\r\n     * http://openlayers.org/en/v3.4.0/examples/image-vector-layer.html\r\n     */\r\n    /*\r\n    var highlight;\r\n    var countryFeatureOverlay;\r\n    \r\n    var displayFeatureInfo = function (pixel) {\r\n\r\n        var info,\r\n            feature;\r\n\r\n        feature = mapModule.map.forEachFeatureAtPixel(pixel, function (feature) { // feature, layer\r\n            return feature;\r\n        });\r\n\r\n        info = document.getElementById('map_info');\r\n        if (feature) {\r\n            info.innerHTML = feature.getId() + ': ' + feature.get('name');\r\n        } else {\r\n            info.innerHTML = '&nbsp;';\r\n        }\r\n\r\n        if (feature !== highlight) {\r\n            if (highlight) {\r\n                countryFeatureOverlay.removeFeature(highlight);\r\n            }\r\n            if (feature) {\r\n                countryFeatureOverlay.addFeature(feature);\r\n            }\r\n            highlight = feature;\r\n        }\r\n\r\n    };*/\r\n\r\n\r\n\r\n    /**\r\n     *\r\n     * See http://openlayers.org/en/v3.4.0/examples/kml.html\r\n     */\r\n\r\n    /*var displayKMLFeatureInfo = function (pixel) {\r\n\r\n        var features = [],\r\n            info,\r\n            i,\r\n            ii;\r\n        mapModule.map.forEachFeatureAtPixel(pixel, function (feature) { // feature, layer\r\n            features.push(feature);\r\n        });\r\n        if (features.length > 0) {\r\n            info = [];\r\n            for (i = 0, ii = features.length; i < ii; i = i + 1) {\r\n                info.push(features[i].get('name'));\r\n            }\r\n            document.getElementById('map_info').innerHTML = info.join(', ') || '(unknown)';\r\n            mapModule.map.getTarget().style.cursor = 'pointer';\r\n        } else {\r\n            document.getElementById('map_info').innerHTML = '&nbsp;';\r\n            mapModule.map.getTarget().style.cursor = '';\r\n        }\r\n    };*/\r\n    \r\n    \r\n    /*\r\n    var viewResolution = / ** @type {number} * / (view.getResolution());\r\n    gridSource.forDataAtCoordinateAndResolution(coordinate, viewResolution,\r\n        function (data) {\r\n\r\n            console.log('Show country details');\r\n            if (data) {\r\n                console.log('Show country details: ' + JSON.stringify(data));\r\n                $('#country_details').modal('show');\r\n                var id = appModule.countryCodesISO2[data.id].toLowerCase();\r\n                countryDetailsModule.showCountryDetails(id);\r\n            }\r\n\r\n        }\r\n    );\r\n    */\r\n\r\n\r\n\r\n    \r\n\r\n    $(function () {\r\n        \r\n        \r\n        //var highlightStyleCache = {}; \r\n        \r\n        var mapElement = document.getElementById('map');\r\n        var popupElement = document.getElementById('popup');\r\n        //var flagElement = document.getElementById('country-flag');\r\n        //var nameElement = document.getElementById('country-name');\r\n\r\n        // Tooltip\r\n        // See http://openlayers.org/en/v3.4.0/examples/kml-timezones.html\r\n        mapTooltip = $('#map-tooltip');\r\n        //console.info('#map-tooltip:'+JSON.stringify(mapTooltip));\r\n        mapTooltip.tooltip({\r\n            animation: false,\r\n            trigger: 'manual'\r\n        });\r\n\r\n\r\n        \r\n        $.when(appModule.deferred.ready.map, appModule.countriesData).done(function () {    \r\n            \r\n            // Map click event\r\n            // See http://openlayers.org/en/v3.4.0/examples/kml-timezones.html\r\n            // See http://openlayers.org/en/v3.4.0/examples/kml.html\r\n            // See http://openlayers.org/en/v3.4.0/examples/tileutfgrid.html\r\n            mapModule.map.on('click', function (evt) {\r\n                //displayFeatureInfo(evt.pixel);\r\n                //displayKMLFeatureInfo(evt.pixel);\r\n                _displayFeatureTooltip(evt.pixel);\r\n                // _displayGridSourceInfoOverlay(evt.coordinate);\r\n                _displayCountryDetails(evt.pixel);\r\n            });\r\n\r\n            \r\n            \r\n            // Pointer move\r\n            // See http://openlayers.org/en/v3.4.0/examples/tileutfgrid.html\r\n            // See http://openlayers.org/en/v3.4.0/examples/kml.html\r\n            // See http://openlayers.org/en/v3.4.0/examples/image-vector-layer.html\r\n            mapModule.map.on('pointermove', function (evt) {\r\n\r\n                var pixel,\r\n                    coordinate,\r\n                    hit;\r\n\r\n                if (evt.dragging) {\r\n                    mapTooltip.tooltip('hide');\r\n                    return;\r\n                }\r\n                pixel = mapModule.map.getEventPixel(evt.originalEvent);\r\n                coordinate = mapModule.map.getEventCoordinate(evt.originalEvent);\r\n                hit = mapModule.map.hasFeatureAtPixel(pixel);\r\n\r\n                //displayFeatureInfo(pixel);\r\n                //displayKMLFeatureInfo(pixel);\r\n                // _displayGridSourceInfoOverlay(coordinate);\r\n\r\n                // Popup\r\n                if (evt.dragging) {\r\n                    $(popupElement).popover('destroy');\r\n                    return;\r\n                }\r\n                mapModule.map.getTarget().style.cursor = hit ? 'pointer' : '';\r\n\r\n            });\r\n\r\n\r\n\r\n            // Pointer stop\r\n            // See http://openlayers.org/en/v3.4.0/examples/moveend.html\r\n            mapModule.map.on('moveend', _onMoveEnd);\r\n\r\n\r\n            var mapViewportId = mapModule.map.getViewport();\r\n            \r\n            // Map resize\r\n            $(mapViewportId).resize(function () {\r\n                mapModule.map.updateSize();\r\n                console.log('Map size updated');\r\n            });\r\n\r\n\r\n\r\n            // View change\r\n            // mapModule.map.events.fireEvent('change:view');\r\n\r\n\r\n\r\n            // Mouse move on viewport\r\n            // See http://openlayers.org/en/v3.4.0/examples/kml-timezones.html\r\n            $(mapViewportId).on('mousemove', function (evt) {\r\n                var pixel = mapModule.map.getEventPixel(evt.originalEvent);\r\n                _displayFeatureTooltip(pixel);\r\n            });\r\n            \r\n            console.timeEnd('Map events initialized');\r\n\r\n        });\r\n        \r\n    });\r\n    \r\n    \r\n    \r\n    // return mapModule;\r\n\r\n})(mapModule || {});"]}